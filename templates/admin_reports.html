{% extends "base.html" %}
{% block title %}Admin - Relatórios{% endblock %}
{% block content %}
<h1>Relatórios</h1>

<form method="get" action="{{ url_for('admin_reports') }}">
  <div style="display:grid; grid-template-columns: repeat(4, minmax(140px,1fr)); gap:12px; max-width:900px;">
    <div>
      <label>Início</label>
      <input type="date" name="start" value="{{ start }}">
    </div>
    <div>
      <label>Fim</label>
      <input type="date" name="end" value="{{ end }}">
    </div>
    <div>
      <label>Usuário</label>
      <select name="user_id">
        <option value="">-- Todos --</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if selected_user_id == u.id %}selected{% endif %}>{{ u.username }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="align-self:end;">
      <button class="btn" type="submit">Filtrar</button>
    </div>
  </div>
</form>

<p style="margin-top:12px;">
  <a class="btn secondary" href="{{ url_for('admin_reports_csv', start=start, end=end, user_id=selected_user_id) }}" target="_blank">Exportar CSV (filtrado)</a>
</p>
<p style="margin-top:8px;">
  <a class="btn" href="{{ url_for('admin_reports_xlsx', start=start, end=end, user_id=selected_user_id) }}" target="_blank">Baixar XLSX (filtrado)</a>
</p>

<h2>Totais</h2>
<p><strong>Soma de fusões:</strong> {{ total_fusions }}</p>

<h2>Dispositivos (soma por dispositivo)</h2>
{% if devices %}
  <table class="table">
    <tr><th>Dispositivo</th><th>Registros</th><th>Fusões (soma)</th></tr>
    {% for d in devices %}
      <tr>
        <td>{{ d.device_name }}</td>
        <td>{{ d.registros }}</td>
        <td>{{ d.fusoes }}</td>
      </tr>
    {% endfor %}
  </table>
{% else %}
  <p>Nenhum dispositivo no filtro.</p>
{% endif %}

<h2>Totais por Usuário (no período)</h2>
<p>
  <a class="btn secondary" href="{{ url_for('admin_reports_users_csv', start=start, end=end, user_id=selected_user_id) }}" target="_blank">
    Exportar CSV (por usuário)
  </a>
</p>
{% if users_summary %}
  <table class="table">
    <tr><th>User ID</th><th>Usuário</th><th>Dispositivos distintos</th><th>Registros</th><th>Fusões (soma)</th></tr>
    {% for u in users_summary %}
      <tr>
        <td>{{ u.id }}</td>
        <td>{{ u.username }}</td>
        <td>{{ u.devices }}</td>
        <td>{{ u.registros }}</td>
        <td>{{ u.fusoes }}</td>
      </tr>
    {% endfor %}
  </table>
{% else %}
  <p>Sem dados para este período/filtro.</p>
{% endif %}

<h2>Detalhes</h2>
{% if rows %}
  <table class="table">
    <tr><th>ID</th><th>Usuário</th><th>Dispositivo</th><th>Fusões</th><th>Criado em</th></tr>
    {% for r in rows %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.username }}</td>
        <td>{{ r.device_name }}</td>
        <td>{{ r.fusion_count }}</td>
        <td>{{ r.created_at }}</td>
      </tr>
    {% endfor %}
  </table>
{% else %}
  <p>Sem registros para o filtro selecionado.</p>
{% endif %}

<p style="margin-top:16px;"><a class="btn secondary" href="{{ url_for('admin_home') }}">Voltar</a></p>
{% endblock %}
